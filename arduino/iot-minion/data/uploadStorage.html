<!DOCTYPE HTML>
<html lang="en">

<head>
   <title>Minion ESP32-Upload para Storage</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href='get-file?name=minion-ico.ico' rel='icon' type='image/x-icon' />
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
   <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
   <style>
      /* Style for positioning toast */
      .toast {
         position: absolute;
         top: 10px;
         right: 10px;
      }

      .fileUpload {
         position: relative;
         overflow: hidden;
         margin: 10px;
      }

      .fileUpload input.upload {
         position: absolute;
         top: 0;
         right: 0;
         margin: 0;
         padding: 0;
         font-size: 20px;
         cursor: pointer;
         opacity: 0;
         filter: alpha(opacity=0);
      }
   </style>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta charset="UTF-8">
   <script>
      var _validFileExtensions = [".crt"];
      function hasWhiteSpace(s) {
         return s.indexOf(' ') >= 0;
      }
      function Validate(oForm) {
         var arrInputs = oForm.getElementsByTagName("input");
         for (var i = 0; i < arrInputs.length; i++) {
            var oInput = arrInputs[i];
            if (oInput.type == "file") {
               var sFileName = oInput.value;
               if (sFileName.length > 0) {
                  var blnValid = false;
                  for (var j = 0; j < _validFileExtensions.length; j++) {
                     var sCurExtension = _validFileExtensions[j];
                     if (sFileName.substr(sFileName.length - sCurExtension.length, sCurExtension.length).toLowerCase() == sCurExtension.toLowerCase()) {
                        blnValid = true;
                        break;
                     }
                  }
                  if (hasWhiteSpace(sFileName)) {
                     $('#message').html("Desculpe, o arquivo: <b>" + sFileName + "</b> é inválido, o arquivo não pode conter espaços.");
                     $("#myToast").toast("show");
                     return false;
                  }
                  if (!blnValid) {
                     $('#message').html("Desculpe, o arquivo: <b>" + sFileName + "</b> é inválido, o arquivo deve ter a(s) extensão(ões): <b>" + _validFileExtensions.join(", ") + "</b>.");
                     $("#myToast").toast("show");
                     return false;
                  }
               }
            }
         }
         return true;
      }
      function deleteFile(tipo, filename) {
         const url = '/deleteFile?type=' + tipo;
         var promiseResponse = fetch(url, {
               method: "DELETE",
               headers: {
                  "Content-Type": "application/json",
                  "Accept": "text/plain",
                  "Authorization": "Basic API_MINION_TOKEN"
               },
               body: JSON.stringify({
                  midia: filename
               }),
            });
            promiseResponse.then((data) => {
               console.log(data);
            }).catch((err) => {
               console.log(err);
            }).finally(() => {
               location.href = location.href;
            })
      }
      function uploadFile() {
         var inpFile = document.getElementById('inputFile');
         if (inpFile.value == '') {
            alert('Você precisa escolher um arquivo antes de clicar em upload!');
            return false;
         } else if (Validate(document.getElementById('myForm'))) {
            const url = '/uploadStorage';
            var file = inpFile.files[0];
            const formData = new FormData();
            formData.append("file", file, file.name);
            var promiseResponse = fetch(url, {
               method: "POST",
               headers: {
                  "Authorization": "Basic API_MINION_TOKEN"
               },
               body: formData,
            });
            promiseResponse.then((data) => {
               console.log(data);
            }).catch((err) => {
               console.log(err);
            }).finally(() => {
               location.href = location.href;
            })
         }
      }
   </script>
</head>

<body>
   <p>
   <h1>Upload de arquivos para o storage interno do ESP32</h1>
   </p>
   <p>Espaço Livre: FREESTORAGE | Espaço Usado: USEDSTORAGE | Total de Armazenamento: TOTALSTORAGE </p>
   <form id="myForm">
      <div class="fileUpload btn btn-primary"> <span>Escolher Arquivo</span>
         <input id="inputFile" name="filename" type="file" class="upload" multiple />
      </div>
      <div class="fileUpload btn btn-primary">
         <a onclick="uploadFile()">
            <div class="upload">Upload</div>
         </a>
      </div>
   </form>
   <p>Depois de clicar em upload, levará algum tempo para que o arquivo seja carregado primeiro e depois gravado no
      Storage, não há nenhum indicador de que o upload começou. Por favor, seja paciente.</p>
   <p>Depois de carregada, a página será atualizada e o arquivo recém-carregado aparecerá na lista de arquivos.</p>
   <p>Se um arquivo não aparecer, é porque o arquivo era muito grande ou tinha caracteres incomuns no nome do arquivo
      (como espaços).</p>
   <p>Você pode ver o progresso do upload observando a saída serial.</p>
   <p> FILELIST </p>
   <div class="m-4">
      <div class="toast" id="myToast">
         <div class="toast-header"> <strong class="me-auto"> <img src='get-file?name=minion-ico.ico' alt='minion-ico'
                  type='image/x-icon' width="24" /> Atenção!</strong> <small>IOT Minion </small> <button type="button"
               class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> </div>
         <div id="message" class="toast-body"></div>
      </div>
   </div>
</body>
</html>