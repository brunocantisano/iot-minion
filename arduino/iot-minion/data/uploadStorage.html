<!DOCTYPE HTML>
<html lang="en">
   <head>
      <title>Minion ESP32-Upload para Storage</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
      <link href='get-file?name=minion-ico.ico' rel='icon' type='image/x-icon'/>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
      <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script> 
      <style>/* Style for positioning toast */ .toast{position: absolute; top: 10px; right: 10px;}.fileUpload{position: relative; overflow: hidden; margin: 10px;}.fileUpload input.upload{position: absolute; top: 0; right: 0; margin: 0; padding: 0; font-size: 20px; cursor: pointer; opacity: 0; filter: alpha(opacity=0);}</style>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta charset="UTF-8">
      <script>
         var _validFileExtensions = [".crt"];
         function hasWhiteSpace(s) {
            return s.indexOf(' ') >= 0;
         }
         function Validate(oForm) {
            var arrInputs = oForm.getElementsByTagName("input");
            for (var i = 0; i < arrInputs.length; i++) {
               var oInput = arrInputs[i];
               if (oInput.type == "file") {
                     var sFileName = oInput.value;
                     if (sFileName.length > 0) {
                        var blnValid = false;
                        for (var j = 0; j < _validFileExtensions.length; j++) {
                           var sCurExtension = _validFileExtensions[j];
                           if (sFileName.substr(sFileName.length - sCurExtension.length, sCurExtension.length).toLowerCase() == sCurExtension.toLowerCase()) {
                                 blnValid = true;
                                 break;
                           }
                        }
                        if (hasWhiteSpace(sFileName)) {
                           $('#message').html("Desculpe, o arquivo: <b>" + sFileName + "</b> é inválido, o arquivo não pode conter espaços.");
                           $("#myToast").toast("show");
                           return false;
                        }
                        if (!blnValid) {
                           $('#message').html("Desculpe, o arquivo: <b>" + sFileName + "</b> é inválido, o arquivo deve ter a(s) extensão(ões): <b>" + _validFileExtensions.join(", ") + "</b>.");
                           $("#myToast").toast("show");
                           return false;
                        }
                     }
               }
            }
            return true;
         }
        function checkEmpty(form){
            if(exampleInputFile.value=='') {
                alert('Você precisa escolher um arquivo antes de clicar em upload!');
                return;
            } else {
               postWithHeader(exampleInputFile.value);
            }
        }
        function postWithHeader(fileupload) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/uploadStorage");
            xhr.setRequestHeader("Content-Type", "application/json")
            xhr.setRequestHeader("Accept", "text/plain")
            xhr.setRequestHeader("Authorization", "Basic YnJ1bm86bWluaW9uMTIz")
            const body = JSON.stringify({
               filename: fileupload
            });
            xhr.onload = () => {
            if (xhr.readyState == 4 && xhr.status == 201) {
               console.log(JSON.parse(xhr.responseText));
            } else {
               console.log(`Error: ${xhr.status}`);
            }
            };
            xhr.send(body);
            // location.href = location.href;
        }
        function deleteFile(tipo, filename) {
            const xhr = new XMLHttpRequest();
            xhr.open("DELETE", "/deleteFile?type="+tipo);
            xhr.setRequestHeader("Content-Type", "application/json")
            xhr.setRequestHeader("Accept", "text/plain")
            xhr.setRequestHeader("Authorization", "Basic YnJ1bm86bWluaW9uMTIz")            
            const body = JSON.stringify({
               midia: filename
            });
            xhr.onload = () => {
            if (xhr.readyState == 4 && xhr.status == 201) {
               console.log(JSON.parse(xhr.responseText));
            } else {
               console.log(`Error: ${xhr.status}`);
            }
            };
            xhr.send(body);
            location.href = location.href;
        }
      </script>
   </head>
   <body>
      <p> 
      <h1>Upload de arquivos para o storage interno do ESP32</h1>
      </p>
      <p>Espaço Livre: FREESTORAGE | Espaço Usado: USEDSTORAGE | Total de Armazenamento: TOTALSTORAGE </p>
      <form id="myForm">
         <div class="fileUpload btn btn-primary"> <span>Escolher Arquivo</span> <input type="file" id="exampleInputFile" name="data" class="upload" onlostfocus="Validate(document.getElementById(myForm))"/> </div>
         <div class="fileUpload btn btn-primary"> <span>Upload</span> <input type="button" value="Upload" title="Upload File" name="upload" class="upload" onClick=checkEmpty(document.getElementById(myForm)) /> </div>
      </form>
      <p>Depois de clicar em upload, levará algum tempo para que o arquivo seja carregado primeiro e depois gravado no Storage, não há nenhum indicador de que o upload começou. Por favor, seja paciente.</p>
      <p>Depois de carregada, a página será atualizada e o arquivo recém-carregado aparecerá na lista de arquivos.</p>
      <p>Se um arquivo não aparecer, é porque o arquivo era muito grande ou tinha caracteres incomuns no nome do arquivo (como espaços).</p>
      <p>Você pode ver o progresso do upload observando a saída serial.</p>
      <p> FILELIST </p>
      <div class="m-4">
         <div class="toast" id="myToast">
            <div class="toast-header"> <strong class="me-auto"> <img src='get-file?name=minion-ico.ico' alt='minion-ico' type='image/x-icon' width="24"/> Atenção!</strong> <small>IOT Minion </small> <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button> </div>
            <div id="message" class="toast-body"></div>
         </div>
      </div>
   </body>
</html>